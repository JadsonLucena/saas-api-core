CREATE TYPE "otp_digest_algorithm" AS ENUM (
  'sha1',
  'sha256',
  'sha512'
);

CREATE TYPE "otp_type" AS ENUM (
  'hotp',
  'totp'
);

CREATE TYPE "http_method" AS ENUM (
  'GET',
  'HEAD',
  'POST',
  'PUT',
  'DELETE',
  'CONNECT',
  'OPTIONS',
  'TRACE',
  'PATCH'
);

CREATE TYPE "oauth_type" AS ENUM (
  'private',
  'public'
);

CREATE TYPE "operation_type" AS ENUM (
  'subtraction',
  'percentage'
);

CREATE TYPE "order_state" AS ENUM (
  'cancelled',
  'completed',
  'created',
  'failure',
  'refused',
  'pending',
  'autorized'
);

CREATE TABLE "user" (
  "id" uuid PRIMARY KEY DEFAULT (uuid_generate_v4()),
  "first_name" varchar(255) NOT NULL,
  "last_name" varchar(255) NOT NULL,
  "username" varchar(255) NOT NULL,
  "password" text NOT NULL,
  "picture" text,
  "created_at" timestamp DEFAULT (now()),
  "updated_at" timestamp DEFAULT (now()),
  "disabled_at" timestamp DEFAULT (now())
);

CREATE TABLE "phone" (
  "user_id" uuid NOT NULL,
  "value" varchar(255) NOT NULL,
  "created_at" timestamp DEFAULT (now()),
  "confirmed_at" timestamp DEFAULT (now()),
  "disabled_at" timestamp DEFAULT (now()),
  
  PRIMARY KEY ("user_id", "value"),
  FOREIGN KEY ("user_id") REFERENCES "user" ("id")
);

CREATE TABLE "phone_message_provider" (
  "id" INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  "name" varchar(255) UNIQUE NOT NULL,
  "picture" text,
  "client_id" varchar(255) NOT NULL,
  "client_secret" varchar(255) NOT NULL,
  "created_at" timestamp DEFAULT (now()),
  "updated_at" timestamp DEFAULT (now()),
  "disabled_at" timestamp DEFAULT (now())
);

CREATE TABLE "phone_message" (
  "phone_message_provider_id" int NOT NULL,
  "phone" varchar(255) UNIQUE NOT NULL,
  "mfa" boolean DEFAULT false,
  "created_at" timestamp DEFAULT (now()),
  "disabled_at" timestamp DEFAULT (now()),

  PRIMARY KEY ("phone_message_provider_id", "phone"),
  FOREIGN KEY ("phone_message_provider_id") REFERENCES "phone_message_provider" ("id"),
  FOREIGN KEY ("phone") REFERENCES "phone" ("value")
);

CREATE TABLE "email" (
  "user_id" uuid NOT NULL,
  "value" varchar(255) PRIMARY KEY NOT NULL,
  "mfa" boolean DEFAULT false,
  "created_at" timestamp DEFAULT (now()),
  "confirmed_at" timestamp DEFAULT (now()),
  "disabled_at" timestamp DEFAULT (now()),

  UNIQUE INDEX ("user_id", "value"),
  FOREIGN KEY ("user_id") REFERENCES "user" ("id")
);

CREATE TABLE "otp" (
  "id" uuid PRIMARY KEY DEFAULT (uuid_generate_v4()),
  "secret" varchar(255) NOT NULL,
  "digestAlgorithm" otp_digest_algorithm NOT NULL,
  "length" int NOT NULL DEFAULT (CHECK(quantity > 0)),
  "variation" int NOT NULL DEFAULT (CHECK(quantity >= 0)),
  "type" otp_type NOT NULL,
  "user_id" uuid NOT NULL,
  "created_at" timestamp DEFAULT (now()),
  "updated_at" timestamp DEFAULT (now()),
  "disabled_at" timestamp DEFAULT (now()),

  UNIQUE INDEX ("secret", "digestAlgorithm", "length", "type"),
  FOREIGN KEY ("user_id") REFERENCES "user" ("id")
);

CREATE TABLE "passkey" (
  "credential_id" text PRIMARY KEY NOT NULL,
  "Public_key" text UNIQUE NOT NULL,
  "user_id" uuid NOT NULL,
  "created_at" timestamp DEFAULT (now()),
  "updated_at" timestamp DEFAULT (now()),
  "disabled_at" timestamp DEFAULT (now()),

  FOREIGN KEY ("user_id") REFERENCES "user" ("id")
);

CREATE TABLE "identity_provider" (
  "id" INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  "name" varchar(255) UNIQUE NOT NULL,
  "picture" text,
  "client_id" varchar(255) NOT NULL,
  "client_secret" varchar(255) NOT NULL,
  "created_at" timestamp DEFAULT (now()),
  "updated_at" timestamp DEFAULT (now()),
  "disabled_at" timestamp DEFAULT (now())
);

CREATE TABLE "sign_in_with" (
  "identity_provider_id" int NOT NULL,
  "user_id" uuid NOT NULL,
  "username" varchar(255) NOT NULL,
  "name" varchar(255) NOT NULL,
  "picture" text,
  "access_token" varchar(255) NOT NULL,
  "expires_in" timestamp NOT NULL,
  "refresh_token" varchar(255) NOT NULL,
  "refresh_token_expires_in" timestamp,
  "created_at" timestamp DEFAULT (now()),
  "updated_at" timestamp DEFAULT (now()),
  "disabled_at" timestamp DEFAULT (now()),
  
  PRIMARY KEY ("identity_provider_id", "user_id", "username"),
  UNIQUE INDEX ("identity_provider_id", "username"),
  FOREIGN KEY ("identity_provider_id") REFERENCES "identity_provider" ("id"),
  FOREIGN KEY ("user_id") REFERENCES "user" ("id")
);

CREATE TABLE "account" (
  "id" uuid PRIMARY KEY DEFAULT (uuid_generate_v4()),
  "name" varchar(255) NOT NULL,
  "picture" text,
  "created_at" timestamp DEFAULT (now()),
  "updated_at" timestamp DEFAULT (now()),
  "disabled_at" timestamp DEFAULT (now())
);

CREATE TABLE "scope" (
  "id" INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  "uri" varchar(255),
  "method" http_method,
  "created_at" timestamp DEFAULT (now()),
  "disabled_at" timestamp DEFAULT (now())
);

CREATE TABLE "role" (
  "id" uuid PRIMARY KEY DEFAULT (uuid_generate_v4()),
  "name" varchar(255) NOT NULL,
  "account_id" uuid NOT NULL,
  "user_id" uuid NOT NULL,
  "created_at" timestamp DEFAULT (now()),
  "disabled_at" timestamp DEFAULT (now()),

  UNIQUE INDEX ("name", "account_id", "user_id"),
  FOREIGN KEY ("account_id") REFERENCES "account" ("id"),
  FOREIGN KEY ("user_id") REFERENCES "user" ("id")
);

CREATE TABLE "acl" (
  "role_id" uuid NOT NULL,
  "scope_id" int NOT NULL

  PRIMARY KEY ("role_id", "scope_id"),
  FOREIGN KEY ("role_id") REFERENCES "role" ("id"),
  FOREIGN KEY ("scope_id") REFERENCES "scope" ("id")
);

CREATE TABLE "member" (
  "id" uuid PRIMARY KEY DEFAULT (uuid_generate_v4()),
  "account_id" uuid NOT NULL,
  "user_id" uuid NOT NULL,
  "role_id" uuid NOT NULL,
  "created_at" timestamp DEFAULT (now()),
  "confirmed_at" timestamp DEFAULT (now()),
  "updated_at" timestamp DEFAULT (now()),
  "disabled_at" timestamp DEFAULT (now()),

  UNIQUE INDEX ("account_id", "user_id"),
  FOREIGN KEY ("account_id") REFERENCES "account" ("id"),
  FOREIGN KEY ("user_id") REFERENCES "user" ("id"),
  FOREIGN KEY ("role_id") REFERENCES "role" ("id")
);

CREATE TABLE "token" (
  "id" uuid PRIMARY KEY DEFAULT (uuid_generate_v4()),
  "value" text UNIQUE NOT NULL,
  "member_id" uuid NOT NULL,
  "role_id" uuid NOT NULL,
  "expires_in" timestamp NOT NULL,
  "created_at" timestamp DEFAULT (now()),
  "disabled_at" timestamp DEFAULT (now()),

  FOREIGN KEY ("member_id") REFERENCES "member" ("id"),
  FOREIGN KEY ("role_id") REFERENCES "role" ("id")
);

CREATE TABLE "oauth" (
  "id" uuid PRIMARY KEY DEFAULT (uuid_generate_v4()),
  "name" varchar(255) NOT NULL,
  "picture" text,
  "allow_origin" text NOT NULL,
  "homepage_url" text NOT NULL,
  "privacy_policy_url" text NOT NULL,
  "terms_of_service_url" text NOT NULL,
  "redirect_url" text NOT NULL,
  "type" oauth_type NOT NULL,
  "access_token" varchar(255) NOT NULL,
  "refresh_token" varchar(255) NOT NULL,
  "member_id" uuid NOT NULL,
  "role_id" uuid NOT NULL,
  "created_at" timestamp DEFAULT (now()),
  "updated_at" timestamp DEFAULT (now()),
  "disabled_at" timestamp DEFAULT (now()),

  UNIQUE INDEX ("name", "member_id"),
  FOREIGN KEY ("member_id") REFERENCES "member" ("id"),
  FOREIGN KEY ("role_id") REFERENCES "role" ("id")
);

CREATE TABLE "oauth_access_token" (
  "value" varchar(255) PRIMARY KEY NOT NULL,
  "expires_in" timestamp NOT NULL DEFAULT (CHECK(quantity > NOW())),
  "oauth_id" uuid NOT NULL,
  "member_id" uuid NOT NULL,
  "role_id" uuid NOT NULL,
  "created_at" timestamp DEFAULT (now()),
  "disabled_at" timestamp DEFAULT (now()),

  UNIQUE INDEX ("oauth_id", "member_id"),
  FOREIGN KEY ("oauth_id") REFERENCES "oauth" ("id"),
  FOREIGN KEY ("member_id") REFERENCES "member" ("id"),
  FOREIGN KEY ("role_id") REFERENCES "role" ("id")
);

CREATE TABLE "oauth_refresh_token" (
  "value" varchar(255) PRIMARY KEY NOT NULL,
  "expires_in" timestamp NOT NULL DEFAULT (CHECK(quantity > NOW())),
  "oauth_id" uuid NOT NULL,
  "member_id" uuid NOT NULL,
  "oauth_access_token" varchar(255) NOT NULL,
  "created_at" timestamp DEFAULT (now()),
  "disabled_at" timestamp DEFAULT (now()),

  UNIQUE INDEX ("oauth_id", "member_id", "oauth_access_token"),
  FOREIGN KEY ("oauth_id") REFERENCES "oauth" ("id"),
  FOREIGN KEY ("member_id") REFERENCES "member" ("id"),
  FOREIGN KEY ("oauth_access_token") REFERENCES "oauth_access_token" ("value")
);

CREATE TABLE "customer" (
  "id" uuid PRIMARY KEY DEFAULT (uuid_generate_v4()),
  "member_id" uuid UNIQUE NOT NULL,
  "tax_id" varchar(255) NOT NULL,
  "is_legal_person" boolean NOT NULL,
  "birthdate" timestamp NOT NULL,
  "created_at" timestamp DEFAULT (now()),
  "disabled_at" timestamp DEFAULT (now()),

  FOREIGN KEY ("member_id") REFERENCES "member" ("id")
);

CREATE TABLE "credit_card" (
  "customer_id" uuid NOT NULL,
  "name" varchar(255) NOT NULL,
  "number" varchar(255) NOT NULL,
  "expires" timestamp NOT NULL,
  "cvv" int NOT NULL,
  "created_at" timestamp DEFAULT (now()),
  "disabled_at" timestamp DEFAULT (now()),

  FOREIGN KEY ("customer_id") REFERENCES "customer" ("id")
);

CREATE TABLE "address" (
  "id" uuid PRIMARY KEY DEFAULT (uuid_generate_v4()),
  "country" varchar(255) NOT NULL,
  "postal_code" varchar(255) NOT NULL,
  "state" varchar(255) NOT NULL,
  "city" varchar(255) NOT NULL,
  "street" varchar(255) NOT NULL,
  "note" text,
  "created_at" timestamp DEFAULT (now()),
  "disabled_at" timestamp DEFAULT (now())
);

CREATE TABLE "customer_address" (
  "customer_id" uuid NOT NULL,
  "address_id" uuid NOT NULL,
  "number" varchar(255),

  FOREIGN KEY ("customer_id") REFERENCES "customer" ("id"),
  FOREIGN KEY ("address_id") REFERENCES "address" ("id")
);

CREATE TABLE "consumption" (
  "account_id" uuid NOT NULL,
  "data" text NOT NULL,
  "amount" number NOT NULL,
  "created_at" timestamp DEFAULT (now()),
  "disabled_at" timestamp DEFAULT (now()),

  FOREIGN KEY ("account_id") REFERENCES "account" ("id")
);

CREATE TABLE "discount" (
  "id" uuid PRIMARY KEY DEFAULT (uuid_generate_v4()),
  "description" text,
  "amount" number NOT NULL,
  "type" operation_type NOT NULL,
  "quantity" int NOT NULL DEFAULT (CHECK(quantity > 0)),
  "cumulative" boolean DEFAULT false,
  "start_at" timestamp NOT NULL,
  "expire_at" timestamp NOT NULL,
  "created_at" timestamp DEFAULT (now()),
  "disabled_at" timestamp DEFAULT (now())
);

CREATE TABLE "coupon" (
  "id" uuid PRIMARY KEY DEFAULT (uuid_generate_v4()),
  "discount_id" uuid NOT NULL,
  "start_at" timestamp DEFAULT (now()),
  "expires_at" timestamp NOT NULL,
  "code" varchar(255) NOT NULL,
  "created_at" timestamp DEFAULT (now()),
  "disabled_at" timestamp DEFAULT (now()),

  FOREIGN KEY ("discount_id") REFERENCES "discount" ("id")
);

CREATE TABLE "product" (
  "id" uuid PRIMARY KEY DEFAULT (uuid_generate_v4()),
  "discount_id" uuid NOT NULL,
  "name" varchar(255) NOT NULL,
  "description" text,
  "picture" text,
  "sku" varchar(255),
  "price" number NOT NULL,
  "quantity" int NOT NULL DEFAULT (CHECK(quantity > 0)),
  "lifetime" timestamp NOT NULL,
  "data" longtext,
  "created_at" timestamp DEFAULT (now()),
  "disabled_at" timestamp DEFAULT (now()),

  FOREIGN KEY ("discount_id") REFERENCES "discount" ("id")
);

CREATE TABLE "order" (
  "id" uuid PRIMARY KEY DEFAULT (uuid_generate_v4()),
  "account_id" uuid NOT NULL,
  "user_id" uuid NOT NULL,
  "coupon_id" uuid NOT NULL,
  "detail" text,
  "created_at" timestamp DEFAULT (now()),
  "confirmed_at" timestamp DEFAULT (now()),
  "disabled_at" timestamp DEFAULT (now()),

  FOREIGN KEY ("account_id") REFERENCES "account" ("id"),
  FOREIGN KEY ("user_id") REFERENCES "user" ("id"),
  FOREIGN KEY ("coupon_id") REFERENCES "coupon" ("id")
);

CREATE TABLE "order_status" (
  "order_id" uuid NOT NULL,
  "data" text NOT NULL,
  "token" text NOT NULL,
  "state" order_state NOT NULL,
  "created_at" timestamp DEFAULT (now()),

  FOREIGN KEY ("order_id") REFERENCES "order" ("id")
);

CREATE TABLE "item" (
  "order_id" uuid NOT NULL,
  "product_id" uuid NOT NULL,
  "quantity" int NOT NULL DEFAULT 1,
  "disabled_at" timestamp DEFAULT (now()),

  FOREIGN KEY ("order_id") REFERENCES "order" ("id"),
  FOREIGN KEY ("product_id") REFERENCES "product" ("id")
);